<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <style>
        /* CSS: Definition der professionellen Laborumgebung */
        * { box-sizing: border-box; }
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 5px; height: 100vh; display: flex; overflow: hidden; }
        .wrapper { display: flex; gap: 5px; width: 100%; height: 100%; }
        
        .sidebar { width: 240px; display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; }
        .module { background: #1a1a1a; padding: 6px; border-radius: 4px; border: 1px solid #333; display: flex; flex-direction: column; gap: 3px; }
        h3 { color: #00adb5; font-size: 11px; margin: 0; border-bottom: 1px solid #333; padding-bottom: 2px; text-transform: uppercase; }
        
        label { font-size: 9px; color: #777; }
        
        select, input, .sensor-input-box { 
            width: 100%; background: #252525; color: white; border: 1px solid #3d3d3d; 
            border-radius: 2px; font-size: 11px; height: 20px; display: flex; align-items: center; padding: 0 6px;
        }

        .row { display: flex; gap: 4px; }
        .col { flex: 1; }

        /* SENSORDATEN: Exakte Abstände und Einheiten - KORRIGIERT: Helligkeit gedimmt auf #bbbbbb */
        .sensor-container { display: flex; flex-direction: column; gap: 4px; margin-top: 2px; }
        .sensor-label { color: #777; font-size: 9px; font-weight: bold; white-space: pre; }
        .sensor-val { flex: 1; text-align: left; font-family: monospace; font-weight: bold; color: #bbbbbb; font-size: 11px; }

        /* STATUS UND GAS: Einheitliche Schriftgröße 11px für Werte (KORRIGIERT: #bbbbbb), 9px für Status-Box */
        .status-row { margin-top: 4px; display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 3px 5px; border-radius: 3px; border: 1px solid #333; }
        .status-val-box { font-size: 9px; font-weight: bold; padding: 1px 6px; border-radius: 2px; text-transform: uppercase; color: #bbbbbb; }
        
        /* LEDS */
        .status-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; background: #000; padding: 5px; border-radius: 4px; border: 1px solid #333; }
        .led-item { display: flex; flex-direction: column; align-items: center; font-size: 9px; color: #aaa; }
        .led { margin-top: 2px; width: 8px; height: 8px; border-radius: 50%; background: #333; }
        .green  { background: #28a745; box-shadow: 0 0 5px #28a745; }
        .orange { background: #ffa500; box-shadow: 0 0 5px #ffa500; }
        .red    { background: #dc3545; box-shadow: 0 0 6px #dc3545; animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        .content { flex-grow: 1; background: #000; display: flex; justify-content: center; align-items: center; border-radius: 4px; overflow: hidden; }
        #live-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        button { height: 20px; border-radius: 2px; font-size: 10px; font-weight: bold; width: 100%; cursor: pointer; border: none; }
        .btn-green { background: #28a745; color: white; }
        .btn-grey { background: #666; color: white; }

        button:active { transform: scale(0.98); filter: brightness(0.9);}

    </style>
</head>
<body>
<div class="wrapper">
    <div class="sidebar">
        <div class="status-grid">
            <div class="led-item">MIC <div id="led-mic" class="led orange"></div></div>
            <div class="led-item">SPEC <div id="led-spec" class="led orange"></div></div>
            <div class="led-item">ENV <div id="led-env" class="led orange"></div></div>
            <div class="led-item">SYS <div id="led-sys" class="led green"></div></div>
        </div>

        <div class="module">
            <h3>1. Proben-Identifikation</h3>
            <div class="row">
                <div class="col"><label>Typ</label><select id="p_type"><option value="B">Bohrprobe</option><option value="W">Wischprobe</option><option value="M">Material</option><option value="R">Referenz</option></select></div>
                <div class="col"><label>ID</label><input type="text" id="p_name" value="P_01"></div>
            </div>
            <label>Position</label><input type="text" id="p_pos" value="Zentrum">
        </div>

        <div class="module">
            <h3>2. Optik & Kalibrierung</h3>
            <div class="row">
                <div class="col"><label>Licht</label><select id="m_light"><option value="R">Ring</option><option value="C">Coax</option><option value="S">Side</option><option value="O">Off</option></select></div>
                <div class="col"><label>Pol</label><select id="m_pol"><option value="P0">Aus</option><option value="P1">Ein</option></select></div>
            </div>
            <label>Cal (px/mm)</label><input type="number" id="cal_factor" value="115" oninput="updateCal()">
        </div>

        <div class="module">
            <h3>3. Umgebungsdaten</h3>
            <div class="sensor-container">
                <div class="sensor-input-box">
                    <span class="sensor-label">Temp. 1:  </span>
                    <span class="sensor-val"><span id="val-t1">--</span> °C</span>
                    <span class="sensor-label" style="margin-left:6px;">rel LF 1:  </span>
                    <span class="sensor-val"><span id="val-h1">--</span> %</span>
                </div>
                <div class="sensor-input-box">
                    <span class="sensor-label">Temp. 2:  </span>
                    <span class="sensor-val"><span id="val-t2">--</span> °C</span>
                    <span class="sensor-label" style="margin-left:6px;">rel LF 2:  </span>
                    <span class="sensor-val"><span id="val-h2">--</span> %</span>
                </div>
            </div>
            <div id="gas-row" class="status-row">
                <span style="font-size:9px; color:#777; font-weight:bold;">GAS:  </span>
                <span id="val-gas" style="font-weight:bold; font-family:monospace; font-size:11px; color:#bbbbbb;">--</span>
            </div>
            <div class="status-row">
                <span style="font-size:9px; color:#777; font-weight:bold;">STATUS:  </span>
                <span id="val-alarm" class="status-val-box" style="color:#bbbbbb;">INIT</span>
            </div>
        </div>

        <div class="module">
            <h3>4. Spektrometer</h3>
            <label>Modus</label>
            <select id="x_mode"><option value="A">Absorption</option><option value="T">Transmission</option><option value="S">Scope</option></select>
            <button class="btn-green" style="margin-top:5px" onclick="saveSpec()">SPEKTRENDATEI SPEICHERN</button>
        </div>

        <div class="module" style="margin-top:auto">
            <div id="status-text" style="font-size:10px; text-align:center; color:#00ff00; margin-bottom:3px">Bereit</div>
            <button id="freeze-btn" class="btn-grey" onclick="toggleFreeze()">STANDBILD</button>
            <button class="btn-green" style="height:28px; margin-top:3px" onclick="saveSnapshot()">BILDDATEI SPEICHERN</button>
        </div>
    </div>
    <div class="content"><img id="live-img" src="{{ url_for('video_feed') }}"></div>
</div>

<script>
    /**
     * JAVASCRIPT: Steuerung der Dashboard-Logik
     */
    function update() {
        fetch('/get_env_data').then(r => r.json()).then(d => {
            document.getElementById('val-t1').innerText = d.t1;
            document.getElementById('val-h1').innerText = d.h1;
            document.getElementById('val-t2').innerText = d.t2;
            document.getElementById('val-h2').innerText = d.h2;
            document.getElementById('val-gas').innerText = d.gas;
            
            const alarmBox = document.getElementById('val-alarm');
            const gasRow = document.getElementById('gas-row');
            const envLed = document.getElementById('led-env');
            
            alarmBox.innerText = d.alarm;

            const status = d.alarm.toLowerCase();
            if(status === "alarm") {
                alarmBox.style.background = "#dc3545"; alarmBox.style.color = "white";
                gasRow.style.background = "#dc3545"; envLed.className = "led red";
            } else if(status === "normal" || status === "bereit") {
                alarmBox.style.background = "#28a745"; alarmBox.style.color = "white";
                gasRow.style.background = "#252525"; envLed.className = "led green";
            }
        });
    }
    setInterval(update, 1000);

    function updateCal() { 
        fetch('/set_cal', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({cal: document.getElementById('cal_factor').value}) }); 
    }

    function toggleFreeze() { fetch('/toggle_freeze', {method: 'POST'}); }

    function saveSnapshot() {
        const d = { 
            type: document.getElementById('p_type').value, name: document.getElementById('p_name').value, 
            pos: document.getElementById('p_pos').value, light: document.getElementById('m_light').value, 
            pol: document.getElementById('m_pol').value, cal: document.getElementById('cal_factor').value 
        };
        fetch('/snapshot', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(d) })
        .then(() => { flashLed('led-mic'); document.getElementById('status-text').innerText = "DATEI GESPEICHERT"; });
    }

    function saveSpec() {
        const d = { 
            type: document.getElementById('p_type').value, 
            name: document.getElementById('p_name').value, 
            pos:  document.getElementById('p_pos').value,   // <--- Das ist neu
            mode: document.getElementById('x_mode').value 
        };
        
        // Senden der Daten an Python
        fetch('/save_spectro', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(d) })
        .then(() => { 
            flashLed('led-spec'); 
            document.getElementById('status-text').innerText = "DATEI GESPEICHERT"; 
        });
    }

    function flashLed(id) { 
        const l = document.getElementById(id); l.className = "led green"; 
        setTimeout(() => { l.className = "led orange"; }, 2000); 
    }
</script>
</body>
</html>