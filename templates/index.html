<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>HAZION EMBEDDED SYSTEM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0a0a0a; --sidebar: #161616; --accent: #007bff; --text: #cccccc; --led-off: #333; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', 'Courier New', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header & Status-LEDs */
        header { background: #111; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .led-group { display: flex; gap: 20px; }
        .led-box { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; }
        .led { width: 12px; height: 12px; border-radius: 50%; background: var(--led-off); }
        .led.green { background: #0f0; box-shadow: 0 0 8px #0f0; }
        .led.red { background: #f00; box-shadow: 0 0 8px #f00; }

        main { display: flex; flex: 1; }
        
        /* Sidebar: Permanent Controls & Values */
        aside { width: 340px; background: var(--sidebar); border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 20px; box-sizing: border-box; }
        .section-title { font-size: 0.75rem; color: #555; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; font-weight: bold; }
        
        /* Mode Buttons */
        .btn-stack { display: flex; flex-direction: column; gap: 5px; }
        .mode-btn { padding: 12px; background: #222; border: 1px solid #444; color: #888; cursor: pointer; text-align: left; transition: 0.3s; }
        .mode-btn.active { background: var(--accent); color: white; border-color: #0056b3; }

        /* Naming Scheme Form */
        .input-group { background: #1e1e1e; padding: 10px; border-radius: 4px; }
        select, input { width: 100%; background: #000; color: #fff; border: 1px solid #444; padding: 8px; margin-bottom: 8px; box-sizing: border-box; }
        
        /* Permanent Sensor Display: Two Spaces after Colon */
        .sidebar-values { background: #111; padding: 10px; border: 1px solid #333; }
        .val-line { font-size: 0.95rem; margin: 5px 0; font-weight: bold; }

        /* Main Viewport */
        #viewport { flex: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; }
        #video_feed { max-width: 100%; max-height: 100%; display: block; }
        #overlay_canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Climate Chart View */
        #chart_view { display: none; width: 100%; height: 100%; padding: 30px; box-sizing: border-box; background: #050505; }
        
        button#save_btn { width: 100%; padding: 15px; background: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <header>
        <div style="font-weight: bold; letter-spacing: 2px;">HAZION EMBEDDED SYSTEM</div>
        <div class="led-group">
            <div class="led-box"><div class="led" id="led_micro"></div> MIKROSKOP</div>
            <div class="led-box"><div class="led" id="led_spec"></div> SPEKTRUM</div>
            <div class="led-box"><div class="led" id="led_clim"></div> KLIMA</div>
        </div>
    </header>

    <main>
        <aside>
            <div class="section-title">BETRIEBSMODUS</div>
            <div class="btn-stack">
                <button class="mode-btn active" id="btn_micro" onclick="setMode('micro')">Mikroskop-Modus</button>
                <button class="mode-btn" id="btn_spec" onclick="setMode('spec')">Spektrum-Modus</button>
                <button class="mode-btn" id="btn_clim" onclick="setMode('clim')">Klimadaten-Modus</button>
            </div>

            <div class="section-title">NAMING SCHEME</div>
            <div class="input-group">
                <select id="inp_typ">
                    <option value="B">Bohrprobe (B)</option>
                    <option value="W">Wischprobe (W)</option>
                    <option value="M">Material (M)</option>
                    <option value="R">Referenz (R)</option>
                </select>
                <input type="text" id="inp_id" placeholder="Projekt/Proben-ID">
                <input type="text" id="inp_pos" placeholder="Position (z.B. L1)">
                
                <div id="micro_extra">
                    <select id="inp_licht">
                        <option value="R">Ring (R)</option>
                        <option value="C">Coax (C)</option>
                        <option value="S">Side (S)</option>
                        <option value="O">Off (O)</option>
                    </select>
                    <select id="inp_pol">
                        <option value="On">Pol: Ein</option>
                        <option value="Off">Pol: Aus</option>
                    </select>
                </div>
                <button id="save_btn" onclick="saveData()">DATENSATZ SPEICHERN</button>
            </div>

            <div class="section-title">ECHTZEIT-ÜBERWACHUNG</div>
            <div class="sidebar-values">
                <div class="val-line" id="disp_gas" style="color:#ffcc00;">Gas:  --- ppm</div>
                <div class="val-line" id="disp_t1">T1:  --.- °C</div>
                <div class="val-line" id="disp_rh1">RH1:  --.- %</div>
                <div class="val-line" id="disp_t2">T2:  --.- °C</div>
                <div class="val-line" id="disp_rh2">RH2:  --.- %</div>
            </div>
        </aside>

        <section id="viewport">
            <div id="video_layer" style="width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
                <img id="video_feed" src="/video_feed">
                <canvas id="overlay_canvas"></canvas>
            </div>
            <div id="chart_view">
                <canvas id="climateChart"></canvas>
            </div>
        </section>
    </main>

    <script>
        let currentMode = 'micro';
        const canvas = document.getElementById('overlay_canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video_feed');

        // Chart.js Initialisierung
        const chartCtx = document.getElementById('climateChart').getContext('2d');
        const climateChart = new Chart(chartCtx, {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'T1 (°C)', data: [], borderColor: '#ff4444', backgroundColor: 'rgba(255,68,68,0.1)', fill: true },
                { label: 'RH1 (%)', data: [], borderColor: '#4444ff', backgroundColor: 'rgba(68,68,255,0.1)', fill: true }
            ]},
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#222' } }, x: { grid: { color: '#222' } } } }
        });

        // SSE Connection [cite: 73, 213, 232]
        const evtSource = new EventSource("/stream");
        evtSource.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if(data.type === 'climate_update') {
                const v = data.payload.values;
                // Präzisionsformatierung: Zwei Leerzeichen
                document.getElementById('disp_gas').innerText = `Gas:  ${v.gas} ppm`;
                document.getElementById('disp_t1').innerText = `T1:  ${v.t1.toFixed(1)} °C`;
                document.getElementById('disp_t2').innerText = `T2:  ${v.t2.toFixed(1)} °C`;
                document.getElementById('disp_rh1').innerText = `RH1:  ${v.rh1.toFixed(1)} %`;
                document.getElementById('disp_rh2').innerText = `RH2:  ${v.rh2.toFixed(1)} %`;
                
                updateChart(v.t1, v.rh1);
                updateLeds(data.payload.leds);
            }
        };

        function setMode(mode) {
            currentMode = mode;
            // Buttons UI
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn_' + mode).classList.add('active');

            // Sichtbarkeit umschalten
            document.getElementById('video_layer').style.display = (mode === 'clim') ? 'none' : 'flex';
            document.getElementById('chart_view').style.display = (mode === 'clim') ? 'block' : 'none';
            document.getElementById('micro_extra').style.display = (mode === 'micro') ? 'block' : 'none';
            
            if(mode === 'micro') drawScale();
        }

        function updateChart(t, rh) {
            const timeLabel = new Date().toLocaleTimeString();
            climateChart.data.labels.push(timeLabel);
            climateChart.data.datasets[0].data.push(t);
            climateChart.data.datasets[1].data.push(rh);
            if(climateChart.data.labels.length > 30) {
                climateChart.data.labels.shift();
                climateChart.data.datasets.forEach(d => d.data.shift());
            }
            climateChart.update('none');
        }

        function updateLeds(leds) {
            ['micro', 'spec', 'clim'].forEach(sys => {
                document.getElementById('led_' + sys).className = 'led ' + leds[sys];
            });
        }

        // 1mm Maßstab: Unten rechts fixiert
        function drawScale() {
            canvas.width = video.clientWidth;
            canvas.height = video.clientHeight;
            if(currentMode !== 'micro') return;

            const pxPerMm = 125.0; // Standard 4x
            const scaleFactor = canvas.width / 960.0; 
            const len = pxPerMm * scaleFactor;

            const x = canvas.width - len - 20;
            const y = canvas.height - 30;

            ctx.strokeStyle = "#0f0"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + len, y);
            ctx.moveTo(x, y-5); ctx.lineTo(x, y+5);
            ctx.moveTo(x+len, y-5); ctx.lineTo(x+len, y+5); ctx.stroke();

            ctx.fillStyle = "#0f0"; ctx.font = "bold 13px monospace"; ctx.textAlign = "center";
            ctx.fillText("1mm", x + (len/2), y - 10);
        }

        window.addEventListener('resize', drawScale);
        setInterval(() => { if(currentMode === 'micro') drawScale(); }, 1000);
    </script>
</body>
</html>