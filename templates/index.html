<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Hazion Embedded System</title>
    <style>
        :root { --bg: #0f0f0f; --panel: #1e1e1e; --text: #d4d4d4; --accent: #0056b3; --success: #28a745; --danger: #dc3545; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: grid; grid-template-rows: 50px 1fr; height: 100vh; overflow: hidden; }
        
        /* Header & Status-LEDs */
        header { background: var(--panel); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #333; justify-content: space-between; }
        .led-group { display: flex; gap: 20px; }
        .led-box { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; text-transform: uppercase; }
        .led { width: 12px; height: 12px; border-radius: 50%; background: #333; box-shadow: inset 0 0 4px #000; }
        .led.green { background: #0f0; box-shadow: 0 0 10px #0f0; }
        .led.red { background: #f00; box-shadow: 0 0 10px #f00; }
        .led.blink { animation: blink 0.8s infinite; background: #f00; }
        @keyframes blink { 50% { opacity: 0.2; } }

        /* Layout */
        main { display: grid; grid-template-columns: 320px 1fr; gap: 0; }
        aside { background: var(--panel); border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Viewport & Scale */
        #viewport { position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #video_feed { max-width: 100%; max-height: 100%; object-fit: contain; }
        #overlay_canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* Controls & Formats */
        .group-label { font-size: 0.7rem; color: #666; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .control-block { background: #252525; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        select, input { width: 100%; background: #333; border: 1px solid #444; color: #fff; padding: 6px; margin: 5px 0; font-size: 0.85rem; }
        
        .mode-btn-group { display: flex; gap: 5px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 8px; background: #333; border: none; color: #888; cursor: pointer; font-size: 0.75rem; font-weight: bold; transition: 0.2s; }
        .mode-btn.active { background: var(--accent); color: white; }

        /* Sensor Display (Strict Formatting) */
        .sensor-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .sensor-card { background: #1a1a1a; padding: 8px; border-radius: 3px; border: 1px solid #333; }
        .sensor-label { font-size: 0.65rem; color: #777; }
        .sensor-value { font-size: 1rem; font-family: 'Courier New', monospace; font-weight: bold; }

        button#btn_save { width: 100%; padding: 12px; background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button#btn_save:disabled { background: #444; cursor: not-allowed; }
    </style>
</head>
<body>
    <header>
        <div style="font-weight: bold; letter-spacing: 1px;">HAZION EMBEDDED SYSTEM</div>
        <div class="led-group">
            <div class="led-box"><div class="led" id="led_micro"></div> Mikroskop </div>
            <div class="led-box"><div class="led" id="led_spec"></div> Spektrum </div>
            <div class="led-box"><div class="led" id="led_clim"></div> Klima </div>
        </div>
    </header>
    <main>
        <aside>
            <div class="group-label">Betriebsmodus</div>
            <div class="mode-btn-group">
                <button class="mode-btn active" onclick="setMode('micro', this)">Mikroskop-Modus</button>
                <button class="mode-btn" onclick="setMode('spec', this)">Spektrum-Modus</button>
                <button class="mode-btn" onclick="setMode('clim', this)">Klimadaten-Modus</button>
            </div>

            <div class="group-label">Naming Scheme (ML-Konform)</div>
            <div class="control-block">
                <select id="inp_typ">
                    <option value="B">Bohrprobe (B)</option>
                    <option value="W">Wischprobe (W)</option>
                    <option value="M">Material (M)</option>
                    <option value="R">Referenz (R)</option>
                </select>
                <input type="text" id="inp_id" placeholder="Projekt-ID" oninput="validate()">
                <input type="text" id="inp_pos" placeholder="Position/Ort" oninput="validate()">
                
                <div id="micro_options">
                    <select id="inp_licht">
                        <option value="R">Ring (R)</option>
                        <option value="C">Coax (C)</option>
                        <option value="S">Side (S)</option>
                        <option value="O">Off (O)</option>
                    </select>
                    <select id="inp_pol">
                        <option value="On">Pol: Ein</option>
                        <option value="Off">Pol: Aus</option>
                    </select>
                    <select id="inp_mag" onchange="updateScale()">
                        <option value="Micro_4x">Objektiv 4x</option>
                        <option value="Micro_10x">Objektiv 10x</option>
                        <option value="Micro_40x">Objektiv 40x</option>
                    </select>
                </div>
                <div id="preview" style="font-size: 0.6rem; color: #555; margin-top: 5px;"></div>
                <button id="btn_save" onclick="saveData()">DATENSATZ SPEICHERN</button>
            </div>

            <div class="group-label">Umweltparameter</div>
            <div class="control-block">
                <div class="sensor-row">
                    <div class="sensor-card"><div class="sensor-label">T1 (°C)</div><div class="sensor-value" id="val_t1">T1:  --.-</div></div>
                    <div class="sensor-card"><div class="sensor-label">RH1 (%)</div><div class="sensor-value" id="val_rh1">RH1:  --.-</div></div>
                    <div class="sensor-card"><div class="sensor-label">T2 (°C)</div><div class="sensor-value" id="val_t2">T2:  --.-</div></div>
                    <div class="sensor-card"><div class="sensor-label">RH2 (%)</div><div class="sensor-value" id="val_rh2">RH2:  --.-</div></div>
                </div>
                <div class="sensor-card" style="margin-top:8px; text-align: center;">
                    <div class="sensor-label">Gas (ppm)</div><div class="sensor-value" id="val_gas">GAS:  ---</div>
                </div>
            </div>
        </aside>
        
        <div id="viewport">
            <img id="video_feed" src="/video_feed">
            <canvas id="overlay_canvas"></canvas>
        </div>
    </main>

    <script>
        let currentMode = 'micro';
        const calibration = { "Micro_4x": 125.0, "Micro_10x": 312.5, "Micro_40x": 1250.0 };
        
        const evtSource = new EventSource("/stream");
        evtSource.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if(data.type === 'climate_update') {
                const v = data.payload.values;
                // Präzisionsvorgabe: Zwei Leerzeichen nach Doppelpunkt
                document.getElementById('val_t1').innerText = `T1:  ${v.t1.toFixed(1)}`;
                document.getElementById('val_t2').innerText = `T2:  ${v.t2.toFixed(1)}`;
                document.getElementById('val_rh1').innerText = `RH1:  ${v.rh1.toFixed(1)}`;
                document.getElementById('val_rh2').innerText = `RH2:  ${v.rh2.toFixed(1)}`;
                document.getElementById('val_gas').innerText = `GAS:  ${v.gas}`;
                updateLeds(data.payload.leds);
            }
        };

        function setMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('micro_options').style.display = (mode === 'micro') ? 'block' : 'none';
            drawScale();
        }

        function validate() {
            const regex = /^[a-zA-Z0-9_-]+$/;
            const idValid = regex.test(document.getElementById('inp_id').value);
            const posValid = regex.test(document.getElementById('inp_pos').value);
            document.getElementById('btn_save').disabled = !(idValid && posValid);
        }

        /* --- Metrologie: 1mm Maßstab fixiert unten rechts --- */
        const canvas = document.getElementById('overlay_canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video_feed');

        function drawScale() {
            canvas.width = video.clientWidth;
            canvas.height = video.clientHeight;
            if(currentMode !== 'micro') return;

            const mag = document.getElementById('inp_mag').value;
            const pxPerMm = calibration[mag];
            const scaleFactor = canvas.width / 960.0; // Basierend auf Stream-Resolution
            const len = pxPerMm * scaleFactor;

            // Fixiert unten rechts
            const x = canvas.width - len - 40;
            const y = canvas.height - 40;

            ctx.strokeStyle = "#0f0";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y); ctx.lineTo(x + len, y);
            ctx.moveTo(x, y-5); ctx.lineTo(x, y+5);
            ctx.moveTo(x+len, y-5); ctx.lineTo(x+len, y+5);
            ctx.stroke();

            ctx.fillStyle = "#0f0";
            ctx.font = "bold 14px monospace";
            ctx.textAlign = "center";
            ctx.fillText("1mm", x + (len/2), y - 10); // Zentriert über der Linie
        }
        
        window.addEventListener('resize', drawScale);
        setInterval(drawScale, 500);
    </script>
</body>
</html>